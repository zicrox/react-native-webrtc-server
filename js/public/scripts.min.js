/******/ (function(modules) { // webpackBootstrap
/******/ 	// The module cache
/******/ 	var installedModules = {};
/******/
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/
/******/ 		// Check if module is in cache
/******/ 		if(installedModules[moduleId]) {
/******/ 			return installedModules[moduleId].exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = installedModules[moduleId] = {
/******/ 			i: moduleId,
/******/ 			l: false,
/******/ 			exports: {}
/******/ 		};
/******/
/******/ 		// Execute the module function
/******/ 		modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);
/******/
/******/ 		// Flag the module as loaded
/******/ 		module.l = true;
/******/
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/
/******/
/******/ 	// expose the modules object (__webpack_modules__)
/******/ 	__webpack_require__.m = modules;
/******/
/******/ 	// expose the module cache
/******/ 	__webpack_require__.c = installedModules;
/******/
/******/ 	// define getter function for harmony exports
/******/ 	__webpack_require__.d = function(exports, name, getter) {
/******/ 		if(!__webpack_require__.o(exports, name)) {
/******/ 			Object.defineProperty(exports, name, {
/******/ 				configurable: false,
/******/ 				enumerable: true,
/******/ 				get: getter
/******/ 			});
/******/ 		}
/******/ 	};
/******/
/******/ 	// getDefaultExport function for compatibility with non-harmony modules
/******/ 	__webpack_require__.n = function(module) {
/******/ 		var getter = module && module.__esModule ?
/******/ 			function getDefault() { return module['default']; } :
/******/ 			function getModuleExports() { return module; };
/******/ 		__webpack_require__.d(getter, 'a', getter);
/******/ 		return getter;
/******/ 	};
/******/
/******/ 	// Object.prototype.hasOwnProperty.call
/******/ 	__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };
/******/
/******/ 	// __webpack_public_path__
/******/ 	__webpack_require__.p = "";
/******/
/******/ 	// Load entry module and return exports
/******/ 	return __webpack_require__(__webpack_require__.s = 0);
/******/ })
/************************************************************************/
/******/ ([
/* 0 */
/***/ (function(module, exports) {


// var socket = io();
var socket = io("https://react-native-webrtc.herokuapp.com");
// var socket = io("http://localhost:4444");

var RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection || window.msRTCPeerConnection;
var RTCSessionDescription = window.RTCSessionDescription || window.mozRTCSessionDescription || window.webkitRTCSessionDescription || window.msRTCSessionDescription;
navigator.getUserMedia = navigator.getUserMedia || navigator.mozGetUserMedia || navigator.webkitGetUserMedia || navigator.msGetUserMedia;

var twilioIceServers = [
     { url: 'stun:global.stun.twilio.com:3478?transport=udp' }
     // { url: 'turn:global.turn.twilio.com:3478?transport=udp',
     //   username: 'ea757ad2c42b932c7f2abe480295e7eb039dc2b13b78c86bc412818ed51e5eea',
     //   credential: 'MPnnojPRoPDI+B3kLONGF9P440Lb8NkrTq+FxxJBVro=' },
     // { url: 'turn:global.turn.twilio.com:3478?transport=tcp',
     //   username: 'ea757ad2c42b932c7f2abe480295e7eb039dc2b13b78c86bc412818ed51e5eea',
     //   credential: 'MPnnojPRoPDI+B3kLONGF9P440Lb8NkrTq+FxxJBVro=' },
     // { url: 'turn:global.turn.twilio.com:443?transport=tcp',
     //   username: 'ea757ad2c42b932c7f2abe480295e7eb039dc2b13b78c86bc412818ed51e5eea',
     //   credential: 'MPnnojPRoPDI+B3kLONGF9P440Lb8NkrTq+FxxJBVro=' } 
];
var configuration = {"iceServers": [{"url": "stun:stun.l.google.com:19302"}]};
// configuration.iceServers = twilioIceServers;

var pcPeers = {};
var selfView = document.getElementById("selfView");
var remoteViewContainer = document.getElementById("remoteViewContainer");
var localStream;

function getLocalStream() {
  navigator.getUserMedia({ "audio": true, "video": false }, function (stream) {
    localStream = stream;
    selfView.src = URL.createObjectURL(stream);
    selfView.muted = true;
  }, logError);
}

function join(roomID) {
  socket.emit('join', roomID, function(socketIds){
    console.log('join', socketIds);
    for (var i in socketIds) {
      var socketId = socketIds[i];
      // craete OFFER peer connection
      createPC(socketId, true);
    }
  });
}

function createPC(socketId, isOffer) {
  console.log('createPC', socketId, isOffer);
  var pc = new RTCPeerConnection(configuration);
  pcPeers[socketId] = pc;

  pc.onicecandidate = function (event) {
    console.log('onicecandidate', event);
    if (event.candidate) {
      socket.emit('exchange', {'to': socketId, 'candidate': event.candidate });
    }
  };

  function createOffer() {
    console.log('üí∞üí∞üí∞ createOffer');
    pc.createOffer(function(desc) {
      console.log('createOffer', desc);
      pc.setLocalDescription(desc, function () {
        console.log('üéÅüéÅüéÅ setLocalDescription', pc.localDescription.type);
        socket.emit('exchange', {'to': socketId, 'sdp': pc.localDescription });
      }, logError);
    }, logError);
  }

  pc.onnegotiationneeded = function () {
    console.log('onnegotiationneeded');
    if (isOffer) {
      createOffer();
    }
  }

  pc.oniceconnectionstatechange = function(event) {
    console.log('oniceconnectionstatechange', event);
    if (event.target.iceConnectionState === 'connected') {
      createDataChannel();
    }
  };
  pc.onsignalingstatechange = function(event) {
    console.log('onsignalingstatechange', event);
  };

  pc.onaddstream = function (event) {
    console.log('onaddstream', event);
    var element = document.createElement('video');
    element.id = "remoteView" + socketId;
    element.autoplay = 'autoplay';
    element.src = URL.createObjectURL(event.stream);
    remoteViewContainer.appendChild(element);
  };
  pc.addStream(localStream);
  function createDataChannel() {
    if (pc.textDataChannel) {
      return;
    }
    var dataChannel = pc.createDataChannel("text");

    dataChannel.onerror = function (error) {
      console.log("dataChannel.onerror", error);
    };

    dataChannel.onmessage = function (event) {
      console.log("dataChannel.onmessage:", event.data);
      var content = document.getElementById('textRoomContent');
      content.innerHTML = content.innerHTML + '<p>' + socketId + ': ' + event.data + '</p>';
    };

    dataChannel.onopen = function () {
      console.log('dataChannel.onopen');
      var textRoom = document.getElementById('textRoom');
      textRoom.style.display = "block";
    };

    dataChannel.onclose = function () {
      console.log("dataChannel.onclose");
    };

    pc.textDataChannel = dataChannel;
  }
  return pc;
}

function exchange(data) {
  console.log('ü§ëü§ëü§ë exchange');
  var fromId = data.from;
  var pc;
  if (fromId in pcPeers) {
    pc = pcPeers[fromId];
  } else {
    // craete NO OFFER peer connection: only exchange ice candidates
    pc = createPC(fromId, false);
  }

  if (data.sdp) {
    console.log('üíöüíöüíö¬†exchange sdp', data);
    pc.setRemoteDescription(new RTCSessionDescription(data.sdp), function () {
      if (pc.remoteDescription.type === "offer"){
        pc.createAnswer(function(desc) {
          console.log('createAnswer', desc);
          pc.setLocalDescription(desc, function () {
            console.log('üéÅüéÅüéÅ setLocalDescription', pc.localDescription.type);
            socket.emit('exchange', {'to': fromId, 'sdp': pc.localDescription });
          }, logError);
        }, logError);
      }
    }, logError);
  } else {
    console.log('üíôüíôüíô exchange candidate', data);
    pc.addIceCandidate(new RTCIceCandidate(data.candidate));
  }
}

function leave(socketId) {
  console.log('leave', socketId);
  var pc = pcPeers[socketId];
  pc.close();
  delete pcPeers[socketId];
  var video = document.getElementById("remoteView" + socketId);
  if (video) video.remove();
}

socket.on('exchange', function(data){
  console.log('socket.on exchange', data);
  // Some one has created offer in RTCPeerConnection
  // Exchange ice candidates (RTCSessionDescription)
  exchange(data);
});
socket.on('leave', function(socketId){
  console.log('socket.on leave', socketId);
  leave(socketId);
});

socket.on('connect', function() {
  console.log('socket.on connect:', socket);
  getLocalStream();
});

function logError(error) {
  console.log("logError", error);
}

function press() {
  var roomID = document.getElementById('roomID').value;
  if (roomID == "") {
    alert('Please enter room ID');
  } else {
    var roomIDContainer = document.getElementById('roomIDContainer');
    roomIDContainer.parentElement.removeChild(roomIDContainer);
    join(roomID);
  }
}
function muteMicrophone (){
  localStream.getAudioTracks()[0].enabled ? (
    console.log("Mute microphone"),
    localStream.getAudioTracks()[0].enabled = false
  ) : (
    console.log("Unmute microphone"),
    localStream.getAudioTracks()[0].enabled = true
  )
}
function textRoomPress() {
  var text = document.getElementById('textRoomInput').value;
  if (text == "") {
    alert('Enter something');
  } else {
    document.getElementById('textRoomInput').value = '';
    var content = document.getElementById('textRoomContent');
    content.innerHTML = content.innerHTML + '<p>' + 'Me' + ': ' + text + '</p>';
    for (var key in pcPeers) {
      var pc = pcPeers[key];
      pc.textDataChannel.send(text);
    }
  }
}


/***/ })
/******/ ]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vd2VicGFjay9ib290c3RyYXAgYWIzNWIxOWMxY2U5N2ViZTViNTIiLCJ3ZWJwYWNrOi8vLy4vcHVibGljL2pzL21haW4uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOzs7QUFHQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFLO0FBQ0w7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSxtQ0FBMkIsMEJBQTBCLEVBQUU7QUFDdkQseUNBQWlDLGVBQWU7QUFDaEQ7QUFDQTtBQUNBOztBQUVBO0FBQ0EsOERBQXNELCtEQUErRDs7QUFFckg7QUFDQTs7QUFFQTtBQUNBOzs7Ozs7OztBQzVEQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOztBQUVBO0FBQ0EsTUFBTTtBQUNOLFNBQVM7QUFDVDtBQUNBLHNFQUFzRTtBQUN0RSxTQUFTO0FBQ1Q7QUFDQSxzRUFBc0U7QUFDdEUsU0FBUztBQUNUO0FBQ0Esc0U7QUFDQTtBQUNBLHFCQUFxQixnQkFBZ0Isc0NBQXNDO0FBQzNFOztBQUVBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0EsMEJBQTBCLGdDQUFnQztBQUMxRDtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDs7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSwrQkFBK0IsOENBQThDO0FBQzdFO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUNBQWlDLDRDQUE0QztBQUM3RSxPQUFPO0FBQ1AsS0FBSztBQUNMOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQ0FBcUMsMENBQTBDO0FBQy9FLFdBQVc7QUFDWCxTQUFTO0FBQ1Q7QUFDQSxLQUFLO0FBQ0wsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQSxDQUFDOztBQUVEO0FBQ0E7QUFDQTtBQUNBLENBQUM7O0FBRUQ7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiLi9wdWJsaWMvc2NyaXB0cy5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIgXHQvLyBUaGUgbW9kdWxlIGNhY2hlXG4gXHR2YXIgaW5zdGFsbGVkTW9kdWxlcyA9IHt9O1xuXG4gXHQvLyBUaGUgcmVxdWlyZSBmdW5jdGlvblxuIFx0ZnVuY3Rpb24gX193ZWJwYWNrX3JlcXVpcmVfXyhtb2R1bGVJZCkge1xuXG4gXHRcdC8vIENoZWNrIGlmIG1vZHVsZSBpcyBpbiBjYWNoZVxuIFx0XHRpZihpbnN0YWxsZWRNb2R1bGVzW21vZHVsZUlkXSkge1xuIFx0XHRcdHJldHVybiBpbnN0YWxsZWRNb2R1bGVzW21vZHVsZUlkXS5leHBvcnRzO1xuIFx0XHR9XG4gXHRcdC8vIENyZWF0ZSBhIG5ldyBtb2R1bGUgKGFuZCBwdXQgaXQgaW50byB0aGUgY2FjaGUpXG4gXHRcdHZhciBtb2R1bGUgPSBpbnN0YWxsZWRNb2R1bGVzW21vZHVsZUlkXSA9IHtcbiBcdFx0XHRpOiBtb2R1bGVJZCxcbiBcdFx0XHRsOiBmYWxzZSxcbiBcdFx0XHRleHBvcnRzOiB7fVxuIFx0XHR9O1xuXG4gXHRcdC8vIEV4ZWN1dGUgdGhlIG1vZHVsZSBmdW5jdGlvblxuIFx0XHRtb2R1bGVzW21vZHVsZUlkXS5jYWxsKG1vZHVsZS5leHBvcnRzLCBtb2R1bGUsIG1vZHVsZS5leHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKTtcblxuIFx0XHQvLyBGbGFnIHRoZSBtb2R1bGUgYXMgbG9hZGVkXG4gXHRcdG1vZHVsZS5sID0gdHJ1ZTtcblxuIFx0XHQvLyBSZXR1cm4gdGhlIGV4cG9ydHMgb2YgdGhlIG1vZHVsZVxuIFx0XHRyZXR1cm4gbW9kdWxlLmV4cG9ydHM7XG4gXHR9XG5cblxuIFx0Ly8gZXhwb3NlIHRoZSBtb2R1bGVzIG9iamVjdCAoX193ZWJwYWNrX21vZHVsZXNfXylcbiBcdF9fd2VicGFja19yZXF1aXJlX18ubSA9IG1vZHVsZXM7XG5cbiBcdC8vIGV4cG9zZSB0aGUgbW9kdWxlIGNhY2hlXG4gXHRfX3dlYnBhY2tfcmVxdWlyZV9fLmMgPSBpbnN0YWxsZWRNb2R1bGVzO1xuXG4gXHQvLyBkZWZpbmUgZ2V0dGVyIGZ1bmN0aW9uIGZvciBoYXJtb255IGV4cG9ydHNcbiBcdF9fd2VicGFja19yZXF1aXJlX18uZCA9IGZ1bmN0aW9uKGV4cG9ydHMsIG5hbWUsIGdldHRlcikge1xuIFx0XHRpZighX193ZWJwYWNrX3JlcXVpcmVfXy5vKGV4cG9ydHMsIG5hbWUpKSB7XG4gXHRcdFx0T2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIG5hbWUsIHtcbiBcdFx0XHRcdGNvbmZpZ3VyYWJsZTogZmFsc2UsXG4gXHRcdFx0XHRlbnVtZXJhYmxlOiB0cnVlLFxuIFx0XHRcdFx0Z2V0OiBnZXR0ZXJcbiBcdFx0XHR9KTtcbiBcdFx0fVxuIFx0fTtcblxuIFx0Ly8gZ2V0RGVmYXVsdEV4cG9ydCBmdW5jdGlvbiBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIG5vbi1oYXJtb255IG1vZHVsZXNcbiBcdF9fd2VicGFja19yZXF1aXJlX18ubiA9IGZ1bmN0aW9uKG1vZHVsZSkge1xuIFx0XHR2YXIgZ2V0dGVyID0gbW9kdWxlICYmIG1vZHVsZS5fX2VzTW9kdWxlID9cbiBcdFx0XHRmdW5jdGlvbiBnZXREZWZhdWx0KCkgeyByZXR1cm4gbW9kdWxlWydkZWZhdWx0J107IH0gOlxuIFx0XHRcdGZ1bmN0aW9uIGdldE1vZHVsZUV4cG9ydHMoKSB7IHJldHVybiBtb2R1bGU7IH07XG4gXHRcdF9fd2VicGFja19yZXF1aXJlX18uZChnZXR0ZXIsICdhJywgZ2V0dGVyKTtcbiBcdFx0cmV0dXJuIGdldHRlcjtcbiBcdH07XG5cbiBcdC8vIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbFxuIFx0X193ZWJwYWNrX3JlcXVpcmVfXy5vID0gZnVuY3Rpb24ob2JqZWN0LCBwcm9wZXJ0eSkgeyByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwgcHJvcGVydHkpOyB9O1xuXG4gXHQvLyBfX3dlYnBhY2tfcHVibGljX3BhdGhfX1xuIFx0X193ZWJwYWNrX3JlcXVpcmVfXy5wID0gXCJcIjtcblxuIFx0Ly8gTG9hZCBlbnRyeSBtb2R1bGUgYW5kIHJldHVybiBleHBvcnRzXG4gXHRyZXR1cm4gX193ZWJwYWNrX3JlcXVpcmVfXyhfX3dlYnBhY2tfcmVxdWlyZV9fLnMgPSAwKTtcblxuXG5cbi8vIFdFQlBBQ0sgRk9PVEVSIC8vXG4vLyB3ZWJwYWNrL2Jvb3RzdHJhcCBhYjM1YjE5YzFjZTk3ZWJlNWI1MiIsIlxuLy8gdmFyIHNvY2tldCA9IGlvKCk7XG52YXIgc29ja2V0ID0gaW8oXCJodHRwczovL3JlYWN0LW5hdGl2ZS13ZWJydGMuaGVyb2t1YXBwLmNvbVwiKTtcbi8vIHZhciBzb2NrZXQgPSBpbyhcImh0dHA6Ly9sb2NhbGhvc3Q6NDQ0NFwiKTtcblxudmFyIFJUQ1BlZXJDb25uZWN0aW9uID0gd2luZG93LlJUQ1BlZXJDb25uZWN0aW9uIHx8IHdpbmRvdy5tb3pSVENQZWVyQ29ubmVjdGlvbiB8fCB3aW5kb3cud2Via2l0UlRDUGVlckNvbm5lY3Rpb24gfHwgd2luZG93Lm1zUlRDUGVlckNvbm5lY3Rpb247XG52YXIgUlRDU2Vzc2lvbkRlc2NyaXB0aW9uID0gd2luZG93LlJUQ1Nlc3Npb25EZXNjcmlwdGlvbiB8fCB3aW5kb3cubW96UlRDU2Vzc2lvbkRlc2NyaXB0aW9uIHx8IHdpbmRvdy53ZWJraXRSVENTZXNzaW9uRGVzY3JpcHRpb24gfHwgd2luZG93Lm1zUlRDU2Vzc2lvbkRlc2NyaXB0aW9uO1xubmF2aWdhdG9yLmdldFVzZXJNZWRpYSA9IG5hdmlnYXRvci5nZXRVc2VyTWVkaWEgfHwgbmF2aWdhdG9yLm1vekdldFVzZXJNZWRpYSB8fCBuYXZpZ2F0b3Iud2Via2l0R2V0VXNlck1lZGlhIHx8IG5hdmlnYXRvci5tc0dldFVzZXJNZWRpYTtcblxudmFyIHR3aWxpb0ljZVNlcnZlcnMgPSBbXG4gICAgIHsgdXJsOiAnc3R1bjpnbG9iYWwuc3R1bi50d2lsaW8uY29tOjM0Nzg/dHJhbnNwb3J0PXVkcCcgfVxuICAgICAvLyB7IHVybDogJ3R1cm46Z2xvYmFsLnR1cm4udHdpbGlvLmNvbTozNDc4P3RyYW5zcG9ydD11ZHAnLFxuICAgICAvLyAgIHVzZXJuYW1lOiAnZWE3NTdhZDJjNDJiOTMyYzdmMmFiZTQ4MDI5NWU3ZWIwMzlkYzJiMTNiNzhjODZiYzQxMjgxOGVkNTFlNWVlYScsXG4gICAgIC8vICAgY3JlZGVudGlhbDogJ01Qbm5valBSb1BESStCM2tMT05HRjlQNDQwTGI4TmtyVHErRnh4SkJWcm89JyB9LFxuICAgICAvLyB7IHVybDogJ3R1cm46Z2xvYmFsLnR1cm4udHdpbGlvLmNvbTozNDc4P3RyYW5zcG9ydD10Y3AnLFxuICAgICAvLyAgIHVzZXJuYW1lOiAnZWE3NTdhZDJjNDJiOTMyYzdmMmFiZTQ4MDI5NWU3ZWIwMzlkYzJiMTNiNzhjODZiYzQxMjgxOGVkNTFlNWVlYScsXG4gICAgIC8vICAgY3JlZGVudGlhbDogJ01Qbm5valBSb1BESStCM2tMT05HRjlQNDQwTGI4TmtyVHErRnh4SkJWcm89JyB9LFxuICAgICAvLyB7IHVybDogJ3R1cm46Z2xvYmFsLnR1cm4udHdpbGlvLmNvbTo0NDM/dHJhbnNwb3J0PXRjcCcsXG4gICAgIC8vICAgdXNlcm5hbWU6ICdlYTc1N2FkMmM0MmI5MzJjN2YyYWJlNDgwMjk1ZTdlYjAzOWRjMmIxM2I3OGM4NmJjNDEyODE4ZWQ1MWU1ZWVhJyxcbiAgICAgLy8gICBjcmVkZW50aWFsOiAnTVBubm9qUFJvUERJK0Iza0xPTkdGOVA0NDBMYjhOa3JUcStGeHhKQlZybz0nIH0gXG5dO1xudmFyIGNvbmZpZ3VyYXRpb24gPSB7XCJpY2VTZXJ2ZXJzXCI6IFt7XCJ1cmxcIjogXCJzdHVuOnN0dW4ubC5nb29nbGUuY29tOjE5MzAyXCJ9XX07XG4vLyBjb25maWd1cmF0aW9uLmljZVNlcnZlcnMgPSB0d2lsaW9JY2VTZXJ2ZXJzO1xuXG52YXIgcGNQZWVycyA9IHt9O1xudmFyIHNlbGZWaWV3ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJzZWxmVmlld1wiKTtcbnZhciByZW1vdGVWaWV3Q29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJyZW1vdGVWaWV3Q29udGFpbmVyXCIpO1xudmFyIGxvY2FsU3RyZWFtO1xuXG5mdW5jdGlvbiBnZXRMb2NhbFN0cmVhbSgpIHtcbiAgbmF2aWdhdG9yLmdldFVzZXJNZWRpYSh7IFwiYXVkaW9cIjogdHJ1ZSwgXCJ2aWRlb1wiOiBmYWxzZSB9LCBmdW5jdGlvbiAoc3RyZWFtKSB7XG4gICAgbG9jYWxTdHJlYW0gPSBzdHJlYW07XG4gICAgc2VsZlZpZXcuc3JjID0gVVJMLmNyZWF0ZU9iamVjdFVSTChzdHJlYW0pO1xuICAgIHNlbGZWaWV3Lm11dGVkID0gdHJ1ZTtcbiAgfSwgbG9nRXJyb3IpO1xufVxuXG5mdW5jdGlvbiBqb2luKHJvb21JRCkge1xuICBzb2NrZXQuZW1pdCgnam9pbicsIHJvb21JRCwgZnVuY3Rpb24oc29ja2V0SWRzKXtcbiAgICBjb25zb2xlLmxvZygnam9pbicsIHNvY2tldElkcyk7XG4gICAgZm9yICh2YXIgaSBpbiBzb2NrZXRJZHMpIHtcbiAgICAgIHZhciBzb2NrZXRJZCA9IHNvY2tldElkc1tpXTtcbiAgICAgIC8vIGNyYWV0ZSBPRkZFUiBwZWVyIGNvbm5lY3Rpb25cbiAgICAgIGNyZWF0ZVBDKHNvY2tldElkLCB0cnVlKTtcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVQQyhzb2NrZXRJZCwgaXNPZmZlcikge1xuICBjb25zb2xlLmxvZygnY3JlYXRlUEMnLCBzb2NrZXRJZCwgaXNPZmZlcik7XG4gIHZhciBwYyA9IG5ldyBSVENQZWVyQ29ubmVjdGlvbihjb25maWd1cmF0aW9uKTtcbiAgcGNQZWVyc1tzb2NrZXRJZF0gPSBwYztcblxuICBwYy5vbmljZWNhbmRpZGF0ZSA9IGZ1bmN0aW9uIChldmVudCkge1xuICAgIGNvbnNvbGUubG9nKCdvbmljZWNhbmRpZGF0ZScsIGV2ZW50KTtcbiAgICBpZiAoZXZlbnQuY2FuZGlkYXRlKSB7XG4gICAgICBzb2NrZXQuZW1pdCgnZXhjaGFuZ2UnLCB7J3RvJzogc29ja2V0SWQsICdjYW5kaWRhdGUnOiBldmVudC5jYW5kaWRhdGUgfSk7XG4gICAgfVxuICB9O1xuXG4gIGZ1bmN0aW9uIGNyZWF0ZU9mZmVyKCkge1xuICAgIGNvbnNvbGUubG9nKCfwn5Kw8J+SsPCfkrAgY3JlYXRlT2ZmZXInKTtcbiAgICBwYy5jcmVhdGVPZmZlcihmdW5jdGlvbihkZXNjKSB7XG4gICAgICBjb25zb2xlLmxvZygnY3JlYXRlT2ZmZXInLCBkZXNjKTtcbiAgICAgIHBjLnNldExvY2FsRGVzY3JpcHRpb24oZGVzYywgZnVuY3Rpb24gKCkge1xuICAgICAgICBjb25zb2xlLmxvZygn8J+OgfCfjoHwn46BIHNldExvY2FsRGVzY3JpcHRpb24nLCBwYy5sb2NhbERlc2NyaXB0aW9uLnR5cGUpO1xuICAgICAgICBzb2NrZXQuZW1pdCgnZXhjaGFuZ2UnLCB7J3RvJzogc29ja2V0SWQsICdzZHAnOiBwYy5sb2NhbERlc2NyaXB0aW9uIH0pO1xuICAgICAgfSwgbG9nRXJyb3IpO1xuICAgIH0sIGxvZ0Vycm9yKTtcbiAgfVxuXG4gIHBjLm9ubmVnb3RpYXRpb25uZWVkZWQgPSBmdW5jdGlvbiAoKSB7XG4gICAgY29uc29sZS5sb2coJ29ubmVnb3RpYXRpb25uZWVkZWQnKTtcbiAgICBpZiAoaXNPZmZlcikge1xuICAgICAgY3JlYXRlT2ZmZXIoKTtcbiAgICB9XG4gIH1cblxuICBwYy5vbmljZWNvbm5lY3Rpb25zdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKGV2ZW50KSB7XG4gICAgY29uc29sZS5sb2coJ29uaWNlY29ubmVjdGlvbnN0YXRlY2hhbmdlJywgZXZlbnQpO1xuICAgIGlmIChldmVudC50YXJnZXQuaWNlQ29ubmVjdGlvblN0YXRlID09PSAnY29ubmVjdGVkJykge1xuICAgICAgY3JlYXRlRGF0YUNoYW5uZWwoKTtcbiAgICB9XG4gIH07XG4gIHBjLm9uc2lnbmFsaW5nc3RhdGVjaGFuZ2UgPSBmdW5jdGlvbihldmVudCkge1xuICAgIGNvbnNvbGUubG9nKCdvbnNpZ25hbGluZ3N0YXRlY2hhbmdlJywgZXZlbnQpO1xuICB9O1xuXG4gIHBjLm9uYWRkc3RyZWFtID0gZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgY29uc29sZS5sb2coJ29uYWRkc3RyZWFtJywgZXZlbnQpO1xuICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndmlkZW8nKTtcbiAgICBlbGVtZW50LmlkID0gXCJyZW1vdGVWaWV3XCIgKyBzb2NrZXRJZDtcbiAgICBlbGVtZW50LmF1dG9wbGF5ID0gJ2F1dG9wbGF5JztcbiAgICBlbGVtZW50LnNyYyA9IFVSTC5jcmVhdGVPYmplY3RVUkwoZXZlbnQuc3RyZWFtKTtcbiAgICByZW1vdGVWaWV3Q29udGFpbmVyLmFwcGVuZENoaWxkKGVsZW1lbnQpO1xuICB9O1xuICBwYy5hZGRTdHJlYW0obG9jYWxTdHJlYW0pO1xuICBmdW5jdGlvbiBjcmVhdGVEYXRhQ2hhbm5lbCgpIHtcbiAgICBpZiAocGMudGV4dERhdGFDaGFubmVsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBkYXRhQ2hhbm5lbCA9IHBjLmNyZWF0ZURhdGFDaGFubmVsKFwidGV4dFwiKTtcblxuICAgIGRhdGFDaGFubmVsLm9uZXJyb3IgPSBmdW5jdGlvbiAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUubG9nKFwiZGF0YUNoYW5uZWwub25lcnJvclwiLCBlcnJvcik7XG4gICAgfTtcblxuICAgIGRhdGFDaGFubmVsLm9ubWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgY29uc29sZS5sb2coXCJkYXRhQ2hhbm5lbC5vbm1lc3NhZ2U6XCIsIGV2ZW50LmRhdGEpO1xuICAgICAgdmFyIGNvbnRlbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGV4dFJvb21Db250ZW50Jyk7XG4gICAgICBjb250ZW50LmlubmVySFRNTCA9IGNvbnRlbnQuaW5uZXJIVE1MICsgJzxwPicgKyBzb2NrZXRJZCArICc6ICcgKyBldmVudC5kYXRhICsgJzwvcD4nO1xuICAgIH07XG5cbiAgICBkYXRhQ2hhbm5lbC5vbm9wZW4gPSBmdW5jdGlvbiAoKSB7XG4gICAgICBjb25zb2xlLmxvZygnZGF0YUNoYW5uZWwub25vcGVuJyk7XG4gICAgICB2YXIgdGV4dFJvb20gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGV4dFJvb20nKTtcbiAgICAgIHRleHRSb29tLnN0eWxlLmRpc3BsYXkgPSBcImJsb2NrXCI7XG4gICAgfTtcblxuICAgIGRhdGFDaGFubmVsLm9uY2xvc2UgPSBmdW5jdGlvbiAoKSB7XG4gICAgICBjb25zb2xlLmxvZyhcImRhdGFDaGFubmVsLm9uY2xvc2VcIik7XG4gICAgfTtcblxuICAgIHBjLnRleHREYXRhQ2hhbm5lbCA9IGRhdGFDaGFubmVsO1xuICB9XG4gIHJldHVybiBwYztcbn1cblxuZnVuY3Rpb24gZXhjaGFuZ2UoZGF0YSkge1xuICBjb25zb2xlLmxvZygn8J+kkfCfpJHwn6SRIGV4Y2hhbmdlJyk7XG4gIHZhciBmcm9tSWQgPSBkYXRhLmZyb207XG4gIHZhciBwYztcbiAgaWYgKGZyb21JZCBpbiBwY1BlZXJzKSB7XG4gICAgcGMgPSBwY1BlZXJzW2Zyb21JZF07XG4gIH0gZWxzZSB7XG4gICAgLy8gY3JhZXRlIE5PIE9GRkVSIHBlZXIgY29ubmVjdGlvbjogb25seSBleGNoYW5nZSBpY2UgY2FuZGlkYXRlc1xuICAgIHBjID0gY3JlYXRlUEMoZnJvbUlkLCBmYWxzZSk7XG4gIH1cblxuICBpZiAoZGF0YS5zZHApIHtcbiAgICBjb25zb2xlLmxvZygn8J+SmvCfkprwn5KawqBleGNoYW5nZSBzZHAnLCBkYXRhKTtcbiAgICBwYy5zZXRSZW1vdGVEZXNjcmlwdGlvbihuZXcgUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKGRhdGEuc2RwKSwgZnVuY3Rpb24gKCkge1xuICAgICAgaWYgKHBjLnJlbW90ZURlc2NyaXB0aW9uLnR5cGUgPT09IFwib2ZmZXJcIil7XG4gICAgICAgIHBjLmNyZWF0ZUFuc3dlcihmdW5jdGlvbihkZXNjKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ2NyZWF0ZUFuc3dlcicsIGRlc2MpO1xuICAgICAgICAgIHBjLnNldExvY2FsRGVzY3JpcHRpb24oZGVzYywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ/CfjoHwn46B8J+OgSBzZXRMb2NhbERlc2NyaXB0aW9uJywgcGMubG9jYWxEZXNjcmlwdGlvbi50eXBlKTtcbiAgICAgICAgICAgIHNvY2tldC5lbWl0KCdleGNoYW5nZScsIHsndG8nOiBmcm9tSWQsICdzZHAnOiBwYy5sb2NhbERlc2NyaXB0aW9uIH0pO1xuICAgICAgICAgIH0sIGxvZ0Vycm9yKTtcbiAgICAgICAgfSwgbG9nRXJyb3IpO1xuICAgICAgfVxuICAgIH0sIGxvZ0Vycm9yKTtcbiAgfSBlbHNlIHtcbiAgICBjb25zb2xlLmxvZygn8J+SmfCfkpnwn5KZIGV4Y2hhbmdlIGNhbmRpZGF0ZScsIGRhdGEpO1xuICAgIHBjLmFkZEljZUNhbmRpZGF0ZShuZXcgUlRDSWNlQ2FuZGlkYXRlKGRhdGEuY2FuZGlkYXRlKSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gbGVhdmUoc29ja2V0SWQpIHtcbiAgY29uc29sZS5sb2coJ2xlYXZlJywgc29ja2V0SWQpO1xuICB2YXIgcGMgPSBwY1BlZXJzW3NvY2tldElkXTtcbiAgcGMuY2xvc2UoKTtcbiAgZGVsZXRlIHBjUGVlcnNbc29ja2V0SWRdO1xuICB2YXIgdmlkZW8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInJlbW90ZVZpZXdcIiArIHNvY2tldElkKTtcbiAgaWYgKHZpZGVvKSB2aWRlby5yZW1vdmUoKTtcbn1cblxuc29ja2V0Lm9uKCdleGNoYW5nZScsIGZ1bmN0aW9uKGRhdGEpe1xuICBjb25zb2xlLmxvZygnc29ja2V0Lm9uIGV4Y2hhbmdlJywgZGF0YSk7XG4gIC8vIFNvbWUgb25lIGhhcyBjcmVhdGVkIG9mZmVyIGluIFJUQ1BlZXJDb25uZWN0aW9uXG4gIC8vIEV4Y2hhbmdlIGljZSBjYW5kaWRhdGVzIChSVENTZXNzaW9uRGVzY3JpcHRpb24pXG4gIGV4Y2hhbmdlKGRhdGEpO1xufSk7XG5zb2NrZXQub24oJ2xlYXZlJywgZnVuY3Rpb24oc29ja2V0SWQpe1xuICBjb25zb2xlLmxvZygnc29ja2V0Lm9uIGxlYXZlJywgc29ja2V0SWQpO1xuICBsZWF2ZShzb2NrZXRJZCk7XG59KTtcblxuc29ja2V0Lm9uKCdjb25uZWN0JywgZnVuY3Rpb24oKSB7XG4gIGNvbnNvbGUubG9nKCdzb2NrZXQub24gY29ubmVjdDonLCBzb2NrZXQpO1xuICBnZXRMb2NhbFN0cmVhbSgpO1xufSk7XG5cbmZ1bmN0aW9uIGxvZ0Vycm9yKGVycm9yKSB7XG4gIGNvbnNvbGUubG9nKFwibG9nRXJyb3JcIiwgZXJyb3IpO1xufVxuXG5mdW5jdGlvbiBwcmVzcygpIHtcbiAgdmFyIHJvb21JRCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyb29tSUQnKS52YWx1ZTtcbiAgaWYgKHJvb21JRCA9PSBcIlwiKSB7XG4gICAgYWxlcnQoJ1BsZWFzZSBlbnRlciByb29tIElEJyk7XG4gIH0gZWxzZSB7XG4gICAgdmFyIHJvb21JRENvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyb29tSURDb250YWluZXInKTtcbiAgICByb29tSURDb250YWluZXIucGFyZW50RWxlbWVudC5yZW1vdmVDaGlsZChyb29tSURDb250YWluZXIpO1xuICAgIGpvaW4ocm9vbUlEKTtcbiAgfVxufVxuZnVuY3Rpb24gbXV0ZU1pY3JvcGhvbmUgKCl7XG4gIGxvY2FsU3RyZWFtLmdldEF1ZGlvVHJhY2tzKClbMF0uZW5hYmxlZCA/IChcbiAgICBjb25zb2xlLmxvZyhcIk11dGUgbWljcm9waG9uZVwiKSxcbiAgICBsb2NhbFN0cmVhbS5nZXRBdWRpb1RyYWNrcygpWzBdLmVuYWJsZWQgPSBmYWxzZVxuICApIDogKFxuICAgIGNvbnNvbGUubG9nKFwiVW5tdXRlIG1pY3JvcGhvbmVcIiksXG4gICAgbG9jYWxTdHJlYW0uZ2V0QXVkaW9UcmFja3MoKVswXS5lbmFibGVkID0gdHJ1ZVxuICApXG59XG5mdW5jdGlvbiB0ZXh0Um9vbVByZXNzKCkge1xuICB2YXIgdGV4dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0ZXh0Um9vbUlucHV0JykudmFsdWU7XG4gIGlmICh0ZXh0ID09IFwiXCIpIHtcbiAgICBhbGVydCgnRW50ZXIgc29tZXRoaW5nJyk7XG4gIH0gZWxzZSB7XG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RleHRSb29tSW5wdXQnKS52YWx1ZSA9ICcnO1xuICAgIHZhciBjb250ZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RleHRSb29tQ29udGVudCcpO1xuICAgIGNvbnRlbnQuaW5uZXJIVE1MID0gY29udGVudC5pbm5lckhUTUwgKyAnPHA+JyArICdNZScgKyAnOiAnICsgdGV4dCArICc8L3A+JztcbiAgICBmb3IgKHZhciBrZXkgaW4gcGNQZWVycykge1xuICAgICAgdmFyIHBjID0gcGNQZWVyc1trZXldO1xuICAgICAgcGMudGV4dERhdGFDaGFubmVsLnNlbmQodGV4dCk7XG4gICAgfVxuICB9XG59XG5cblxuXG4vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIFdFQlBBQ0sgRk9PVEVSXG4vLyAuL3B1YmxpYy9qcy9tYWluLmpzXG4vLyBtb2R1bGUgaWQgPSAwXG4vLyBtb2R1bGUgY2h1bmtzID0gMCJdLCJzb3VyY2VSb290IjoiIn0=